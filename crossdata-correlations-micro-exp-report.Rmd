# Correlation between microRNAs and their putative targets

```{r calculate-correlations, eval=FALSE, include=FALSE}
  
# Calculate microRNAs/expression correlations for each tissue. 
tissues <- c("CRBLM", "FCTX", "TCTX", "PONS")

dir.create("log")

for(t in tissues) {
  system(paste("R CMD BATCH --no-save --no-restore",
    shQuote(paste("--args tissue=", shQuote(t), sep = "")),
    "crossdata-correlations-micro-exp-analysis.r",
    file.path("log", paste("crossdata-correlations-micro-exp", 
      tolower(t), "output.r", sep = "-"))))
}

# Combine results into a single data.frame
cors.df <- sapply(tissues, simplify = FALSE, function(x)
  read.csv(paste("results/crossdata-micro-exp-correlations-", 
    tolower(x), ".csv", sep = "")))

cors.df <- reshape2::melt(cors.df, id.vars = colnames(cors.df[[1]]))
cors.df <- cbind(tissue = cors.df$L1, subset(cors.df, select = -L1))

# Remove individual results
file.remove(dir("results", pattern = "crossdata-micro-exp-correlations", 
  full.names = TRUE))

# Export combined results as compressed rda file
save(cors.df, file = "results/crossdata-micro-exp-correlations.rda")
```

```{r setup, include=FALSE}
# source("functions/knit_wiki.r")
# knit_wiki("crossdata-correlations-micro-exp-report.Rmd", output.filename = "Correlations between microRNA and mRNA expression data")

report.title <- "crossdata-correlations-micro-exp"
fig.dir <- file.path("figures", report.title)
fig.prefix <- "cors-micro-exp-"

dir.create(fig.dir, showWarnings = FALSE)

opts_knit$set(upload.fun = function(file, 
  key = "ec071b3a0c69857c0db26a477c1a568c") imgur_upload(file, key))

opts_chunk$set(fig.path = file.path(fig.dir, fig.prefix),
  cache.path = paste(".cache-", report.title, "/", sep = ""),
  echo=FALSE, results = 'hide',
  cache=FALSE, fig.width=5, fig.height=4, dpi=150)
```

```{r load-libraries}
library(grid)
library(plyr)
library(ggplot2)
 
source("functions/print_xtable.r")
source("functions/save-figures.r")
```

```{r load-data, cache=FALSE, message=FALSE}
load("data/crossdata-correlations-micro-exp/eset-exp-adjusted.rda")
load("data/crossdata-correlations-micro-exp/eset-micro-adjusted.rda")

load("results/crossdata-micro-exp-correlations.rda")

# Annotate probes
cors.df <- data.frame(cors.df,
  fData(eset.micro)[cors.df$micro, c("chr", "position", "strand")],
  row.names = NULL)
```

Explore and visualize correlation results generated between the microRNA and mRNA expression data.

* script: [`crossdata-correlations-micro-exp-analysis.r`](https://github.com/aaronwolen/gibbs-brain-project/blob/master/crossdata-correlations-micro-exp-analysis.r)
* results: [`crossdata-micro-exp-correlations.csv`](https://github.com/aaronwolen/gibbs-brain-project/blob/master/results/crossdata-micro-exp-correlations.csv)


## Methods

The analysis was performed independently for each tissue. Subsets of the expression and methylation eSet objects were created to include only samples from individuals present in both datasets. mRNA expression levels were adjusted for age and sample tissue bank by fitting a linear model with these variables and using the residuals in the correlation analysis. microRNA expression levels were not adjusted.

microRNA probes were included in this analysis only if the mature microRNA target symbols were present in the mirbase database provided by the `RmiR.hsa` package. This database was used to putative targets for each microRNA. Correlations were calculated between each microRNA and all putative targets listed in the mirbase database, overlap was determined using Entrez IDs. 

Correlations were calculated using the standard `cor` function and with use set to `"pairwise.complete"`. P-values were obtained using the `WGCNA` package's `corPvalueStudent` function and multiple testing corrections were performed using the Benjamini & Hochberg method for generating q-values.

## Results

```{r results-table, results='asis'}
results.table <- ddply(cors.df, .(tissue), summarise, 
  'p-value < 0.05' = sum(pvalue < 0.05),
  'q-value < 0.05' = sum(qvalue < 0.05))

print_xtable(results.table, col.names = TRUE)
```

### Histograms
Histograms of the Pearson correlation values (left) and corresponding p-values (right).

```{r histograms, message=FALSE}
p.hist <- ggplot(cors.df) + 
  aes(x = pvalue) + geom_histogram() +
  facet_grid(tissue~.)

r.hist <- ggplot(cors.df) + 
  aes(x = r) + geom_histogram() +
  geom_vline(xintercept = 0, color = "white") +
  facet_grid(tissue~.)

ggaffy:::ggaffy_layout(nrow = 1, ncol = 2, plot.list = list(r.hist, p.hist))
```


```{r, eval=FALSE}
# Summarize p-values by microRNA probe
mean.pvals <- ddply(cors.df, .(tissue, micro), .progress = "text", summarise,
  mean.abs.cor = mean(abs(r)), mean.pvalue = mean(pvalue))

mean.pvals <- arrange(mean.pvals, mean.pvalue)

ggplot(mean.pvals) + aes(x = tissue, y = micro, fill = -log10(mean.pvalue)) +
  geom_tile()

ggplot(subset(cors.df, micro %in% mean.pvals$micro[1:40])) +
  aes(x = micro, y = -log10(pvalue)) +
  geom_boxplot()

```



```{r examine-sig-probes, include=FALSE}

# Produce visualizations for individual probes with largest correlations
sig.cors <- subset(cors.df, qvalue < .05)
sig.cors <- arrange(sig.cors, qvalue)

# Phenotype data for plots
pdata.cols <- c("geo", "individual", "gender")
pdata <- rbind(pData(eset.exp)[, pdata.cols], pData(eset.micro)[, pdata.cols])

probe.plots <- list()
for(i in 1:50) {
  
  m.probe <- sig.cors$micro[i]
  e.probe <- sig.cors$exp[i]

  probe.df <- data.frame(sample = sampleNames(eset.exp),
    tissue = eset.exp$tissue,
    expression = exprs(eset.exp)[e.probe,], assay = "mRNA", 
    row.names = NULL)
  
  probe.df <- rbind(probe.df,
    data.frame(sample = sampleNames(eset.micro),
      tissue = eset.micro$tissue,
      expression = exprs(eset.micro)[m.probe,], assay = "microRNA",
      row.names = NULL))
   
  probe.df <- merge(probe.df, pdata, by.x = "sample", by.y = "geo") 
    
  probe.df <- reshape2::dcast(probe.df, 
    individual + gender + tissue ~ assay, value.var = "expression")
  
  probe.plots[[paste(m.probe, e.probe, sep = "-")]] <- ggplot(probe.df) +
    aes(x = microRNA, y = mRNA) +
    geom_point(aes(color = gender), alpha = 0.5) +
    geom_rug(alpha = 0.5) +
    facet_wrap(~tissue, ncol = 2)  +
    stat_smooth(method = "lm") +
    xlab(paste("microRNA expression", " (", m.probe, ")", sep = "")) +
    ylab(paste("mRNA expression", " (",  e.probe, ")", sep = "")) +
    opts(title = paste(sig.cors$symbol[i], " (", tolower(sig.cors$tissue[i]), 
      " cor = ", round(sig.cors$r[i], 2), ")", sep = ""))
}

pdf(file.path(fig.dir, paste(fig.prefix, "top-probes.pdf", sep = "")),
    width = 7, height = 6)
temp <- lapply(probe.plots, print)
dev.off()
```



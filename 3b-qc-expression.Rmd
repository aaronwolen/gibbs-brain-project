# QC analysis of expression data

```{r setup, include=FALSE}
# source("functions/knit_wiki.r")
# knit_wiki("3b-qc-expression.Rmd", output.filename = "Expression data QC analysis")

report.title <- "qc-expression"
fig.dir <- file.path("figures", report.title)
fig.prefix <- "mrna-"

dir.create(fig.dir, showWarnings = FALSE)

opts_knit$set(upload.fun = function(file, 
  key = "ec071b3a0c69857c0db26a477c1a568c") imgur_upload(file, key))

opts_chunk$set(fig.path = file.path(fig.dir, fig.prefix),
  cache.path = paste(".cache-", report.title, "/", sep = ""),
  echo=FALSE, results = 'hide',
  cache=FALSE, fig.width=8.5, fig.height=5, dpi=150)
```

```{r load-libraries, message=FALSE}
library(affy)
library(ggplot2)
library(plyr)
library(ggaffy)

source("functions/print_xtable.r")
source("functions/save-figures.r")
```

```{r graphing-tweaks}
# Shrink text so labels are legible along x-axis
axis.text.x <- theme_text(size = 5, colour = "grey50", angle = 90, hjust = 1)

wide.opts <- opts(axis.text.x = axis.text.x, legend.position = "top",
  legend.margin = grid::unit(0, "lines"))

# Nice figure label
log.label <- expression(log[2] * " expression")
```


```{r load-data, cache=FALSE}
load("data/eset-exp.rda")
```

## Sample filters

### Negative expression values

The following table lists all samples with any negative expression values, which reveals a  small number of samples with excessive numbers of negative values.

```{r negative-count-table, results='asis'}
eset.exp$neg.count <- apply(exprs(eset.exp), 2, function(x) sum(x < 0))


neg.table <- data.frame(table(eset.exp$neg.count))

neg.table <- arrange(
  pData(eset.exp)[, c("geo", "individual", "tissue", "neg.count")], 
  desc(neg.count))

neg.table <- subset(neg.table, neg.count > 0)

print_xtable(neg.table, col.names = TRUE)
```


## Distributions of unnormalized data

Data was log-transformed prior to generating the figures below.

```{r log-transform, echo=TRUE, results='markup'}
exprs(eset.exp) <- log2(exprs(eset.exp))
```

### Quantiles plot
```{r quantiles}
ggaffy_quantiles(eset.exp,
  x = "individual", probs = c(0.01, 0.1, 0.25),
  fill = "batch", shape = "gender", facet.row = "tissue") +
  ylab(log.label) + wide.opts
```

### Boxplot
```{r boxplot}
ggaffy_box(eset.exp, x = "individual", color = "batch", facet.row = "tissue",
  add.outliers = TRUE, outlier.size = .5) +
  ylab(log.label) + wide.opts
```

### Relative expression boxplot
```{r boxplot-rle}
ggaffy_box(eset.exp, x = "individual", method = "rle", color = "batch",
  facet.row = "tissue") + ylab(log.label) + wide.opts
```

### Histogram


```{r histogram, warning=FALSE, fig.width=5, fig.height=8.5}
ggaffy_hist(eset.exp, color = "batch", adjust = 0.5, facet.row = "tissue") +
  xlim(c(6, 9)) + xlab(log.label) + wide.opts
```


## Sample clustering
Hierarchical clustering of all samples using euclidean distance produces results very similar to what Gibbs published in [figure 1b](http://www.plosgenetics.org/article/info:doi/10.1371/journal.pgen.1000952?imageURI=info:doi/10.1371/journal.pgen.1000952.g001) of their paper. When pearson correlation distance is used there is very little separation between the two cortical regions.

```{r sample-cluster-heatmap, fig.height=4, fig.width=4.5}
ggaffy_clustmat(eset.exp, color = "tissue", raster = TRUE, 
  dist.method = "euclidean") + 
opts(axis.text.x = theme_blank(), axis.text.y = theme_blank(),
  axis.ticks = theme_blank())
```

## Sample correlations with median reference
Inspect the relationship between each sample and a pseudo-reference sample generated from the gene-wise median across all samples within a given tissue. The following table lists all samples with psuedo-reference correlations that are at least 2 SDs below the tissue-specific mean. 

```{r median-ref-correlations, results='asis'}
tissues <- levels(eset.exp$tissue)

ref.cors <- list()
for(t in tissues) {
  exp.sub <- eset.exp[fData(eset.exp)$chr %in% 1:22, eset.exp$tissue == t]
  exp.mat <- exprs(exp.sub)
  med.ref <- rowMedians(exp.mat)
  cors.sub <- apply(exp.mat, 2, cor, y = med.ref, use = "pairwise.complete")
  cors.sub <- data.frame(tissue = t, sample = sampleNames(exp.sub),
    individual = exp.sub$individual, r = cors.sub)
  ref.cors[[t]] <- cors.sub
}

ref.cors <- data.frame(do.call("rbind", ref.cors), row.names = NULL)

# Calculate outlier threshold
thresh <- mean(ref.cors$r) - (sd(ref.cors$r) * 2)

# Table of outlier samples
ref.cors$outlier <- ifelse(ref.cors$r < thresh, TRUE, FALSE)
print_xtable(subset(ref.cors, outlier, select = -outlier), col.names = TRUE)

# Export correlations
write.csv(ref.cors, paste(file.path(fig.dir, fig.prefix), 
  "median-ref-correlations.csv", sep = ""), row.names = FALSE)
```


### Cerebellum median reference correlations
```{r median-ref-correlations-crblm, fig.height = 8.5}
exp.sub <- eset.exp[, eset.exp$tissue == "CRBLM"]
sampleNames(exp.sub) <- exp.sub$individual
ggaffy_scatgrid(exp.sub)
```

### Pons median reference correlations
```{r median-ref-correlations-pons, fig.height = 8.5}
exp.sub <- eset.exp[, eset.exp$tissue == "PONS"]
sampleNames(exp.sub) <- exp.sub$individual
ggaffy_scatgrid(exp.sub)
```

### Frontal cortex median reference correlations
```{r median-ref-correlations-fctx, fig.height = 8.5}
exp.sub <- eset.exp[, eset.exp$tissue == "FCTX"]
sampleNames(exp.sub) <- exp.sub$individual
ggaffy_scatgrid(exp.sub)
```

### Temporal cortex
```{r median-ref-correlations-tctx, fig.height = 8.5}
exp.sub <- eset.exp[, eset.exp$tissue == "TCTX"]
sampleNames(exp.sub) <- exp.sub$individual
ggaffy_scatgrid(exp.sub)
```
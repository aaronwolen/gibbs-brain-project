# Gender-based methylation differences

```{r setup, include=FALSE}
# source("functions/knit_wiki.r")
# knit_wiki("gender-based-differential-meth-report.Rmd", output.filename = "Gender-based methylation differences")

report.title <- "gender-based-meth-differences"
fig.dir <- file.path("figures", report.title)
fig.prefix <- "meth-gender-"

dir.create(fig.dir, showWarnings = FALSE)

opts_knit$set(upload.fun = function(file, 
  key = "ec071b3a0c69857c0db26a477c1a568c") imgur_upload(file, key))

opts_chunk$set(fig.path = file.path(fig.dir, fig.prefix),
  cache.path = paste(".cache-", report.title, "/", sep = ""),
  echo=FALSE, results = 'hide',
  cache=FALSE, fig.width=5, fig.height=4, dpi=150)


```

```{r load-libraries}
library(plyr)
library(reshape2)
library(ggplot2)

source("functions/plot_matrix.r")
source("functions/heat_matrix.r")
source("functions/print_xtable.r")
source("functions/save-figures.r")
```

```{r load-data, cache=FALSE}
source("4b-load-meth-data.r")

t.results <- read.csv("results/gender-based-differential-methylation.csv",
                      stringsAsFactors = FALSE)
```

Explore and visualize results from the gender-based differential methylation analysis, which sought to identify logi with significantly different levels of methylation between male and female samples.

* script: [`gender-based-differential-meth.r`](https://github.com/aaronwolen/gibbs-brain-project/blob/master/gender-based-differential-meth.r)
* results: [`gender-based-differential-methylation.csv`](https://github.com/aaronwolen/gibbs-brain-project/blob/master/results/gender-based-differential-methylation.csv)

## Methods
The analysis was restricted to only autosomal probes. Low-variance probes were filtered out by removing any probes with an experiment-wide standard deviation < 0.1. 

Methylation levels were adjusted for age and sample tissue bank by fitting a linear model with these variables and using the residuals in subsequent analyses. These models were fit independently for each brain region so the residuals produced would be approximately normal within each region. 

The t.test was carried out using the `rowttests` from the `genefilter` package. Since `rowttests` is unable to handle missing data, any probes with NA values had to be tested individually after removing offending samples.

Multiple testing corrections were performed within each region using the Benjamini & Hochberg method for generating q-values.

## Results

```{r results-table, results='asis'}
results.table <- ddply(t.results, .(tissue), summarise, 
  'p-value < 0.05' = sum(p.value < 0.05),
  'q-value < 0.1' = sum(q.value < 0.01))

print_xtable(results.table, col.names = TRUE)
```

### Volcano plot
Volcano plot of mean gender-based methylation differences plotted against raw t-test p-values. The outlier probe cg15915418 was removed prior to plotting. 

```{r volcano-plot}
vp <- ggplot(t.results) +
  aes(x = dm, y = -log10(p.value)) +
  geom_point(size = 1) +
  facet_wrap(~tissue) +
  xlab("Mean gender difference") + 
  ylab(expression(-log[10] * " p-value"))

# Remove TLE1 outlier
vp %+% subset(t.results, id != "cg15915418")
```


### Pairwise tissue comparisons of mean gender differences
Pairwise comparison of gender-based methylation differences across all tissues. As above, cg15915418 was removed prior to plotting. 

```{r dm-tissue-pairs, fig.width=5.5}
tissues <- unique(eset.meth$tissue)

t.dm <- dcast(t.results, id ~ tissue, value.var = "dm")

plot_matrix(data = subset(t.dm, id != "cg15915418"), 
  facet.vars = tissues, alpha = 0.5, size = 0.75) + 
  stat_smooth(method = "lm") + 
  xlab("Mean gender difference")  + ylab("Mean gender difference")
```

### Mean difference correlations across tissues

As seen in the pairs plot above, gender-based methylation differences do correlate across tissues to some extent. The following heatmap depicts the inter-tissue correlations, which were strongest between PONS/FCTX and TCTX/FCTX. Re-calculating these correlations using only probes with t-test p-values < 0.05 increased these correlations by 0.15 - 0.22. 

```{r dm-tissue-correlations, fig.width=3.5, fig.height=2.5}

dm.cors <- cor(t.dm[, tissues])
heat_matrix(dm.cors, symmetric = TRUE, legend.title = "cor", font.size = 3)

# Limit correlations to probes with larger gender differences
sig.probes <- unique(subset(t.results, p.value < 0.05)$id)
sig.dm.cors <- cor(subset(t.dm, id %in% sig.probes)[, tissues])

sig.dm.cors - dm.cors
```

